Test Harness
============

This README briefly describes the test harness and the specific WarpX example.
The test harness is simply intended to be a shell that will size data buffers
according to parameters extracted from a spiral script.  The buffers will
contain only zeros.  The code generated by the spiral script is called and
timed.  This in no way proves correctness, it merely gives execution time for
the code based on a common setup.

The generic method of using the harness is to:
1.  Create a spiral script and identify the parameters to extract
2.  Run the Python script **runtest.py** to:
    *  Extract the defining parameters from the spiral script to a header file
    *  Run cmake to compile and link the program
    *  Execute the test program

A custom harness program is likely required for each unique problem (or class of
problem).  The following example discusses the harness for WarpX, specifically
the PSATD portion.

### Identify the parameters to extract

The following snippet is from the WarpX Cuda example:
```
prefix := "warpx_cuda";     ##  PICKME #define CUDAFUNCNAME warpx_cuda
t := let(name := prefix,
    n := 80,                ##  PICKME #define cubeN 80
    np := n+1,              ##  PICKME #define cubeNP (cubeN + 1)
    inFields := 11,         ##  PICKME #define INFIELDS 11
    outFields := 6,         ##  PICKME #define OUTFIELDS 6
...
c := opts.fftxGen(tt);
opts.prettyPrint(c);
codefile := prefix::"_80.cu";            ##  PICKME #define CODEFILE "warpx_cuda_80.cu"
PrintTo(codefile, opts.prettyPrint(c));
```

Any parameter used in the spiral script that is relevant to the C code is
identified using the pattern **PICKME** (placed as a spiral comment).  Following
that should be the appropriate C code define.  The Python script, **runtest.py**
will extract the definitions into a header file called **testsizes.h**.

The Cuda code harness, **HarnessWarpxCuda.cu** uses the parameters defined to
size buffers and supply the names of functions to call.

### Build and Test the Spiral script

Once the spiral script is written it can be tested by calling the Python driver.
This driver parses the script extracting the configuration parameters as
necessary and builing a header file, **testsizes.h**, that is included by the
test harness program.  The driver configures the **cmake** file to generate the
source code (from the spiral script), then compile the code, and finally the
driver executes it returning the timing information.  See below for the steps
needed to build a new harness for a different problem.

The name of the test harness program (**HarnessWarpxCuda.cu**) is known to the
python driver.  The driver takes as argument(s) the script(s) to be built and
tested, as follows:
```
python runtest.py GPU_spiral_script [ CPU_spiral_script ]
```
The harness program optionally includes the CPU version of the same script
(configuring/sizeing parameters **must** be identical for both) and times both
the CPU version as well as the GPU version.  If the CPU script name is omitted
then only the GPU version is built and timed.

As a specific example, to build and run both GPU & CPU WarpX codes use the
following command line:
```
python runtest.py ../../library-cuda/warpx-cuda.g ../../library-c/warpx.g
```

### Create a New Harness Program

To create a new test harness program for a different transform or problem do the
following:
1.  Copy the contents of the warpx directory to a new directory in the
    **testharness** folder
2.  Edit the harness program, here it is called **HarnessWarpxCuda.cu**; rename
    it to something more appropriate to the new example.
3.  Edit the **runtest.py** script to change the **_harnessName** variable name
    to the stem  name of the new program.

There should't be any need to modify the **cmake** file assuming no strutural
changes are required for the new harness program.

